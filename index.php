<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharmacie - Connexion Sécurisée</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjAwIDIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cGF0aCBkPSJNNjAgMjAgTDE0MCAyMCBMMTQwIDYwIEwxODAgNjAgTDE4MCAxNDAgTDE0MCAxNDAgTDE0MCAxODAgTDYwIDE4MCBMNTAG0xNDAgTDIwIDE0MCBMMJAG0NjAgTDYwIDYwIFoiIGZpbGw9IiMyMkM1NUUiLz4KICA8cGF0aCBkPSJNNzUgMzUgTDEyNSAzNSBMMTI1IDc1IEwxNjUgNzUgTDE2NSAxMjUgTDEyNSAxMjUgTDEyNSAxNjUgTDc1IDE2NSBMNTAW0xMjUgTDM1IDEyNSBMMzUgNzUgTDc1IDc1IFoiIGZpbGw9IndoaXRlIi8+CiAgPGcgZmlsbD0iIzIyQzU1RSI+CiAgICA8cmVjdCB4PSI5NyIgeT0iNTAiIHdpZHRoPSI2IiBoZWlnaHQ9IjEwMCIvPgogICAgPHBhdGggZD0iTTg1IDcwIFE3NSA3NSA4NSA4NSBRMTETY0NOM5NRCXM0QTEI4MCA3MCAXMW0ZhOVcQgQPNXUgODBZRAMTAwIDkwURA2pUMTAlMjUgMTA1IDFYGNQMRUSMTI1IDkwIDEyMCAxFDwgUTEx1IDExMCAxMDUgMTA1IFE5NSAxGMERJVUAygFJMA=ICQRA2pMA0VMA9NEQR23cWENIDUgcTRWOTU2MTA2M2IETARDUVMGA1UQVEgMG11MC3U0aME0FIFQ5NSAwMFM5IDEwM0UBMRJVDSgEgRAPNIgWRGQCAxTFcQg2mNSAwMWU05IDUCZUEgMa24gBG9SgBGMTaAy5BIUA2pUN0RBRTA1GW5G05IDz1jUQl5IDYgMTMwO0gUGMEJzNIAQNIIQ2NUzXUEgkBXM9TYgB3cSBGOTU2YH0gQVMUR0gERE2QYQcXQQ=="/+gCGAYYCQEIGYGEI8UWUCgDY3cgKYE4CAg0JnJ4IE4nIDUgcj0iOCIgcnk9IjUNICU+CiAgPC9nPgogIDxwYXRoIGQ9Ik05RCBMRMHRC0cXU0MSRE0T0SMRU4UTM5MCBMMHJcSAg2zSUgRiA0NDQ5IGdWlHAEYNIHYGYcSgBGQmNOAEg5MCAMI2NUMRKEgXJVMA0PNOYmNCcQo9IjQ1LEcXQYgQCKzAcNOgGAg5MCBSAwMQYQEIGYNUYgXAg9ACJOBEGJa9G2 JEcTOW3F5MRCAJMA40JQg6PSI5PCBRIQ4gZIVSIG9SGFNXFFgRUAUGRQhYFc6NEw0N0QmBASQ4XQVbKCGY0MSAxaAIMKCYYURgNNCQQUAOJaAgagVOEgcBSA9cRRAMAIBMQg02STgEAYFXNABNNMHA0AH1QgYFUMCAsH0wCCIOFZ0AGQC04NAG0MG5QNGHEQGENaGAIGhBSQU5CrETVQVNYGE9BgcRNBFOMAYBHQAwU5JQ0OOJVCAGXQ4o0YgVNQg9QYyAQEQUQOAHaGUGRaAA4CKGXRA4GHlWS6mNMYGCZRQAZ8VE2mQGAZB0AXNA50OQBFR0QAYG0GGCmQAWAmN2FCEYWRN0AMYQVNQERWFNQAYyPUOJQAFUEQVAGCAgFc6YVUKiGUBAgFEhRQIYAD1gCmgB0YQgU4N9GMgVRaF1Q9z1N0g0sGNAgA4GGQVdXvMgFWYAdYXBMVGAI&5A3QgYGKQVGW2FQhUGYgFMUYPmGIMQAUmYUxGGAJlQVUQd1A1GGNICrFBGYWOtmCA05AGxVNXVCF5Q32FVGwUZRQVCQBFhF1BAQRGAGMAgAsAnBCgOYzaAAKYg3q9EY&" fill="#22C55E"/>
    </g>
    <path d="M90 140 L110 140 Q115 140 115 145 L115 155 Q115 160 110 160 L90 160 Q85 160 85 155 L85 145 Q85 140 90 140 Z" fill="#22C55E"/>
</svg>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f3f4f6;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .card {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            width: 100%;
            max-width: 28rem;
            overflow: hidden;
            transition: all 0.3s ease-in-out;
        }

        .card-header {
            padding: 1.5rem 1.5rem 0;
            text-align: center;
        }

        .logo-container {
            display: flex;
            justify-content: center;
            margin-bottom: 1rem;
        }

        .pharmacy-logo {
            width: 5rem;
            height: 5rem;
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #111827;
            margin-bottom: 0.5rem;
        }

        .card-description {
            color: #6b7280;
            font-size: 0.875rem;
            margin-bottom: 1.5rem;
        }

        .card-content {
            padding: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
            position: relative;
        }

        .label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .input:focus {
            outline: none;
            border-color: #22c55e;
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
        }

        .input::placeholder {
            color: #9ca3af;
        }

        .password-input {
            padding-right: 3rem;
        }

        .otp-input {
            text-align: center;
            font-size: 1.5rem;
            font-weight: 600;
            letter-spacing: 0.5rem;
            padding: 1rem;
        }

        .toggle-password {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: #6b7280;
            padding: 0.25rem;
            border-radius: 0.25rem;
            transition: color 0.15s ease-in-out;
        }

        .toggle-password:hover {
            color: #374151;
        }

        .toggle-password:focus {
            outline: none;
            color: #22c55e;
        }

        .toggle-icon {
            width: 1.25rem;
            height: 1.25rem;
        }

        .error, .success, .info {
            font-size: 0.875rem;
            margin-top: 0.5rem;
            padding: 0.75rem;
            border-radius: 0.375rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .error {
            background-color: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
        }

        .success {
            background-color: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #16a34a;
        }

        .info {
            background-color: #eff6ff;
            border: 1px solid #bfdbfe;
            color: #2563eb;
        }

        .message-icon {
            width: 1.25rem;
            height: 1.25rem;
            flex-shrink: 0;
        }

        .button {
            width: 100%;
            background-color: #22c55e;
            color: white;
            border: none;
            border-radius: 0.375rem;
            padding: 0.625rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.15s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            position: relative;
        }

        .button:hover:not(:disabled) {
            background-color: #16a34a;
        }

        .button:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.3);
        }

        .button:disabled {
            background-color: #d1d5db;
            cursor: not-allowed;
        }

        .button-secondary {
            background-color: #6b7280;
            margin-top: 0.5rem;
        }

        .button-secondary:hover:not(:disabled) {
            background-color: #4b5563;
        }

        .login-icon {
            width: 1rem;
            height: 1rem;
        }

        .hidden {
            display: none;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        .slide-in-right {
            animation: slideInRight 0.3s ease-in-out;
        }

        .countdown {
            font-size: 0.75rem;
            color: #6b7280;
            text-align: center;
            margin-top: 1rem;
        }

        .loading-spinner {
            width: 1rem;
            height: 1rem;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="card">
        <div class="card-header">
            <div class="logo-container">
                <svg viewBox="0 0 200 200" class="pharmacy-logo" xmlns="http://www.w3.org/2000/svg">
                    <path d="M60 20 L140 20 L140 60 L180 60 L180 140 L140 140 L140 180 L60 180 L60 140 L20 140 L20 60 L60 60 Z" fill="#22C55E"/>
                    <path d="M75 35 L125 35 L125 75 L165 75 L165 125 L125 125 L125 165 L75 165 L75 125 L35 125 L35 75 L75 75 Z" fill="white"/>
                    <g fill="#22C55E">
                        <rect x="97" y="50" width="6" height="100"/>
                        <path d="M85 70 Q75 75 85 85 Q110 95 115 80 Q120 70 105 75 Q95 80 100 90 Q105 100 115 95 Q125 90 120 100 Q115 110 105 105 Q95 100 100 110 Q105 120 115 125 Q125 130 115 135 L105 140 Q95 135 105 130 Q115 125 110 120 Q105 115 95 120 Q85 125 90 115 Q95 105 105 110 Q115 115 110 105 Q105 95 95 100 Q85 105 90 95 Q95 85 105 90 Q115 95 110 85 Q105 75 95 80 Q85 85 90 75 Z"/>
                        <ellipse cx="85" cy="72" rx="8" ry="5"/>
                    </g>
                    <path d="M90 140 L110 140 Q115 140 115 145 L115 155 Q115 160 110 160 L90 160 Q85 160 85 155 L85 145 Q85 140 90 140 Z" fill="#22C55E"/>
                </svg>
            </div>
            <h1 class="card-title" id="cardTitle">Connexion Sécurisée</h1>
            <p class="card-description" id="cardDescription">Entrez vos identifiants pour accéder au système</p>
        </div>
        
        <div class="card-content">
            <div id="messageContainer"></div>

            <!-- Step 1: Login Form -->
            <form id="loginForm">
                <div class="form-group">
                    <label for="username" class="label">Nom d'utilisateur</label>
                    <input 
                        type="text" 
                        id="username" 
                        name="username"
                        class="input" 
                        placeholder="Votre nom d'utilisateur" 
                        required
                    />
                </div>
                
                <div class="form-group">
                    <label for="password" class="label">Mot de passe</label>
                    <div style="position: relative;">
                        <input 
                            type="password" 
                            id="password" 
                            name="password"
                            class="input password-input" 
                            placeholder="Votre mot de passe" 
                            required
                        />
                        <button 
                            type="button" 
                            class="toggle-password" 
                            onclick="togglePassword()"
                            aria-label="Afficher/Masquer le mot de passe"
                        >
                            <svg id="eyeIcon" class="toggle-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                            <svg id="eyeOffIcon" class="toggle-icon hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <button type="submit" class="button" id="loginButton">
                    <svg class="login-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"/>
                    </svg>
                    <span id="loginButtonText">Se connecter</span>
                </button>
            </form>

            <!-- Step 2: OTP Verification Form -->
            <form id="otpForm" class="hidden">
                <div class="form-group">
                    <label for="otp" class="label">Code de vérification</label>
                    <input 
                        type="text" 
                        id="otp" 
                        name="otp"
                        class="input otp-input" 
                        placeholder="000000"
                        maxlength="6"
                        pattern="[0-9]{6}"
                        required
                    />
                    <small style="color: #6b7280; font-size: 0.75rem; margin-top: 0.25rem; display: block;">
                        Entrez le code à 6 chiffres envoyé à votre email
                    </small>
                </div>
                
                <button type="submit" class="button" id="otpButton">
                    <svg class="login-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span id="otpButtonText">Vérifier le code</span>
                </button>

                <button type="button" class="button button-secondary" id="resendButton">
                    <svg class="login-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    <span id="resendButtonText">Renvoyer le code</span>
                </button>

                <button type="button" class="button button-secondary" id="backButton">
                    <svg class="login-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                    </svg>
                    Retour à la connexion
                </button>

                <div id="countdown" class="countdown hidden"></div>
            </form>
        </div>
    </div>

    <script>
        let currentStep = 'login';
        let countdownTimer = null;
        let resendCountdown = 60;

        // Form elements
        const loginForm = document.getElementById('loginForm');
        const otpForm = document.getElementById('otpForm');
        const messageContainer = document.getElementById('messageContainer');
        const cardTitle = document.getElementById('cardTitle');
        const cardDescription = document.getElementById('cardDescription');
        
        // Buttons
        const loginButton = document.getElementById('loginButton');
        const otpButton = document.getElementById('otpButton');
        const resendButton = document.getElementById('resendButton');
        const backButton = document.getElementById('backButton');
        
        // Button texts
        const loginButtonText = document.getElementById('loginButtonText');
        const otpButtonText = document.getElementById('otpButtonText');
        const resendButtonText = document.getElementById('resendButtonText');

        // Toggle password visibility
        function togglePassword() {
            const passwordInput = document.getElementById('password');
            const eyeIcon = document.getElementById('eyeIcon');
            const eyeOffIcon = document.getElementById('eyeOffIcon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                eyeIcon.classList.add('hidden');
                eyeOffIcon.classList.remove('hidden');
            } else {
                passwordInput.type = 'password';
                eyeIcon.classList.remove('hidden');
                eyeOffIcon.classList.add('hidden');
            }
        }

        // Show message
        function showMessage(message, type = 'info') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `${type} fade-in`;
            
            let icon = '';
            switch (type) {
                case 'error':
                    icon = `<svg class="message-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                    </svg>`;
                    break;
                case 'success':
                    icon = `<svg class="message-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>`;
                    break;
                default:
                    icon = `<svg class="message-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                    </svg>`;
            }
            
            messageDiv.innerHTML = `${icon}<span>${message}</span>`;
            messageContainer.innerHTML = '';
            messageContainer.appendChild(messageDiv);
        }

        // Clear messages
        function clearMessages() {
            messageContainer.innerHTML = '';
        }

        // Switch to OTP step
        function switchToOTPStep() {
            currentStep = 'otp';
            
            loginForm.classList.add('hidden');
            otpForm.classList.remove('hidden');
            otpForm.classList.add('slide-in-right');
            
            cardTitle.textContent = 'Vérification OTP';
            cardDescription.textContent = 'Un code de vérification a été envoyé à votre email';
            
            document.getElementById('otp').focus();
            startResendCountdown();
        }

        // Switch back to login step
        function switchToLoginStep() {
            currentStep = 'login';
            
            otpForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
            loginForm.classList.add('slide-in-right');
            
            cardTitle.textContent = 'Connexion Sécurisée';
            cardDescription.textContent = 'Entrez vos identifiants pour accéder au système';
            
            clearCountdown();
            clearMessages();
        }

        // Start resend countdown
        function startResendCountdown() {
            resendCountdown = 60;
            resendButton.disabled = true;
            
            const countdownDiv = document.getElementById('countdown');
            countdownDiv.classList.remove('hidden');
            
            countdownTimer = setInterval(() => {
                resendCountdown--;
                countdownDiv.textContent = `Nouveau code disponible dans ${resendCountdown} secondes`;
                resendButtonText.textContent = `Renvoyer le code (${resendCountdown}s)`;
                
                if (resendCountdown <= 0) {
                    clearCountdown();
                    resendButton.disabled = false;
                    resendButtonText.textContent = 'Renvoyer le code';
                    countdownDiv.textContent = 'Vous pouvez maintenant demander un nouveau code';
                }
            }, 1000);
        }

        // Clear countdown
        function clearCountdown() {
            if (countdownTimer) {
                clearInterval(countdownTimer);
                countdownTimer = null;
            }
            document.getElementById('countdown').classList.add('hidden');
        }

        // Set button loading state
        function setButtonLoading(button, textElement, loading = true) {
            if (loading) {
                button.disabled = true;
                textElement.innerHTML = '<div class="loading-spinner"></div>';
            } else {
                button.disabled = false;
                // Reset text based on button type
                if (button === loginButton) {
                    textElement.textContent = 'Se connecter';
                } else if (button === otpButton) {
                    textElement.textContent = 'Vérifier le code';
                } else if (button === resendButton) {
                    textElement.textContent = 'Renvoyer le code';
                }
            }
        }

        // Make API request
        async function makeRequest(action, data) {
            try {
                const formData = new FormData();
                formData.append('action', action);
                
                for (const key in data) {
                    formData.append(key, data[key]);
                }
                
                const response = await fetch('config/auth.php', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('Erreur de réseau');
                }
                
                return await response.json();
            } catch (error) {
                console.error('Request error:', error);
                return { success: false, message: 'Erreur de connexion au serveur' };
            }
        }

        // Handle login form submission
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showMessage('Veuillez remplir tous les champs', 'error');
                return;
            }
            
            clearMessages();
            setButtonLoading(loginButton, loginButtonText, true);
            
            const result = await makeRequest('login', { username, password });
            
            setButtonLoading(loginButton, loginButtonText, false);
            
            if (result.success) {
                showMessage(result.message, 'success');
                
                // Debug: Show OTP in development
                if (result.otp_debug) {
                    setTimeout(() => {
                        showMessage(`Code OTP (dev): ${result.otp_debug}`, 'info');
                    }, 1000);
                }
                
                setTimeout(() => {
                    switchToOTPStep();
                }, 1500);
            } else {
                showMessage(result.message, 'error');
            }
        });

        // Handle OTP form submission
        otpForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const otp = document.getElementById('otp').value.trim();
            
            if (!otp || otp.length !== 6) {
                showMessage('Veuillez entrer un code à 6 chiffres', 'error');
                return;
            }
            
            clearMessages();
            setButtonLoading(otpButton, otpButtonText, true);
            
            const result = await makeRequest('verify_otp', { otp });
            
            setButtonLoading(otpButton, otpButtonText, false);
            
            if (result.success) {
                showMessage(result.message, 'success');
                setTimeout(() => {
                    window.location.href = result.redirect;
                }, 1500);
            } else {
                showMessage(result.message, 'error');
                document.getElementById('otp').value = '';
                document.getElementById('otp').focus();
            }
        });

        // Handle resend OTP
        resendButton.addEventListener('click', async () => {
            clearMessages();
            setButtonLoading(resendButton, resendButtonText, true);
            
            const result = await makeRequest('resend_otp', {});
            
            setButtonLoading(resendButton, resendButtonText, false);
            
            if (result.success) {
                showMessage(result.message, 'success');
                
                // Debug: Show OTP in development
                if (result.otp_debug) {
                    setTimeout(() => {
                        showMessage(`Nouveau code OTP (dev): ${result.otp_debug}`, 'info');
                    }, 1000);
                }
                
                startResendCountdown();
            } else {
                showMessage(result.message, 'error');
            }
        });

        // Handle back button
        backButton.addEventListener('click', () => {
            switchToLoginStep();
        });

        // OTP input formatting
        document.getElementById('otp').addEventListener('input', function(e) {
            // Only allow numbers
            this.value = this.value.replace(/[^0-9]/g, '');
            
            // Auto-submit when 6 digits are entered
            if (this.value.length === 6) {
                setTimeout(() => {
                    otpForm.dispatchEvent(new Event('submit'));
                }, 300);
            }
        });

        // Clear messages when user starts typing
        const allInputs = document.querySelectorAll('.input');
        allInputs.forEach(input => {
            input.addEventListener('input', () => {
                clearMessages();
            });
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl+H to toggle password
            if (e.ctrlKey && e.key === 'h' && currentStep === 'login') {
                e.preventDefault();
                togglePassword();
            }
            
            // Escape to go back in OTP step
            if (e.key === 'Escape' && currentStep === 'otp') {
                switchToLoginStep();
            }
        });

        // Auto-focus on page load
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('username').focus();
        });
    </script>
</body>
</html> 